import QRCode from 'qrcode'
import Relayer, { RelayerEncryptionMode } from './index'

interface RelayerAppData {
    inner: any
    relayer: string
    encryption_mode: RelayerEncryptionMode
}

export class App {
    relayer: Relayer

    element: HTMLDivElement
    contentElement: HTMLDivElement
    qrCodeElement: HTMLDivElement
    loadingElement: HTMLDivElement
    errElement: HTMLDivElement

    constructor(relayer: Relayer) {
        this.relayer = relayer

        this.element = document.createElement(`div`)
        this.element.classList.add(`tos-xswd-relayer`)

        this.contentElement = document.createElement(`div`)
        this.contentElement.classList.add(`tos-xswd-relayer-content`)
        this.element.appendChild(this.contentElement)

        this.loadingElement = document.createElement(`div`)
        this.loadingElement.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.0001 12C20.0001 13.3811 19.6425 14.7386 18.9623 15.9405C18.282 17.1424 17.3022 18.1477 16.1182 18.8587C14.9341 19.5696 13.5862 19.9619 12.2056 19.9974C10.825 20.0328 9.45873 19.7103 8.23975 19.0612" stroke="currentColor" stroke-width="3.55556" stroke-linecap="round"/>
            </svg>
        `
        this.loadingElement.classList.add(`tos-xswd-relayer-loading`)

        this.errElement = document.createElement(`div`)
        this.errElement.classList.add(`tos-xswd-relayer-error`)

        this.qrCodeElement = document.createElement(`div`)
        this.qrCodeElement.classList.add(`tos-xswd-relayer-qrcode`)
        this.qrCodeElement.innerHTML = `
            <div class="tos-xswd-relayer-scan-logo">
                <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4,4h6v6H4V4M20,4v6H14V4h6M14,15h2V13H14V11h2v2h2V11h2v2H18v2h2v3H18v2H16V18H13v2H11V16h3V15m2,0v3h2V15H16M4,20V14h6v6H4M6,6V8H8V6H6M16,6V8h2V6H16M6,16v2H8V16H6M4,11H6v2H4V11m5,0h4v4H11V13H9V11m2-5h2v4H11V6M2,2V6H0V2A2,2,0,0,1,2,0H6V2H2M22,0a2,2,0,0,1,2,2V6H22V2H18V0h4M2,18v4H6v2H2a2,2,0,0,1-2-2V18H2m20,4V18h2v4a2,2,0,0,1-2,2H18V22Z"/>
                </svg>
            </div>
            <div class="tos-xswd-relayer-logo-wrap">
                <div class="tos-xswd-relayer-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                        <path fill="#2EA7E0" d="M42.8,16.81c0.86-1.35,2.64-1.74,3.99-0.89c1.35,0.86,1.74,2.64,0.89,3.99c-0.86,1.35-2.64,1.74-3.99,0.89c-1.19-0.76-1.63-2.23-1.14-3.5l-3.18-1.53c0,0,0,0.01-0.01,0.01c-0.57,0.89-1.75,1.15-2.64,0.59c-0.5-0.32-0.8-0.83-0.87-1.38l-3.02,0.03c-0.03,0.13-0.07,0.26-0.15,0.38c-0.33,0.51-1,0.66-1.51,0.34c-0.51-0.33-0.66-1-0.34-1.51c0.33-0.51,1-0.66,1.51-0.34c0.26,0.17,0.43,0.42,0.48,0.7l3.02-0.03c0.03-0.29,0.12-0.57,0.29-0.83c0.57-0.89,1.75-1.15,2.64-0.59c0.76,0.49,1.06,1.43,0.78,2.25l3.18,1.53C42.76,16.88,42.78,16.85,42.8,16.81z"/>
                        <path fill="#2EA7E0" d="M45.17,11.23c0.47-1.53,2.09-2.38,3.61-1.91c1.53,0.47,2.38,2.09,1.91,3.61c-0.08,0.27-0.2,0.51-0.35,0.74l2.43,1.87c1.02-1.2,2.7-1.74,4.3-1.25c2.15,0.66,3.36,2.94,2.7,5.09c-0.66,2.15-2.94,3.36-5.09,2.7c-2.15-0.66-3.36-2.94-2.7-5.09c0.12-0.41,0.31-0.78,0.54-1.11l-2.43-1.87c-0.73,0.81-1.89,1.18-3,0.84c-1.34-0.41-2.17-1.72-2.02-3.07l-3.47-0.63c0,0,0,0.01,0,0.01c-0.31,1.01-1.38,1.58-2.39,1.27c-0.57-0.18-1-0.59-1.21-1.1l-2.91,0.83c0.01,0.13,0,0.27-0.04,0.41c-0.18,0.58-0.79,0.9-1.37,0.73c-0.58-0.18-0.9-0.79-0.73-1.37c0.18-0.58,0.79-0.9,1.37-0.73c0.29,0.09,0.52,0.29,0.65,0.55l2.91-0.83c-0.05-0.28-0.03-0.58,0.06-0.88c0.31-1.01,1.38-1.58,2.39-1.27c0.87,0.27,1.4,1.09,1.34,1.96l3.47,0.63C45.15,11.31,45.16,11.27,45.17,11.23z"/>
                        <path fill="#172A88" d="M50.55,33.76c1.59,0.07,2.83,1.42,2.76,3.01c-0.07,1.59-1.42,2.83-3.01,2.76c-1.59-0.07-2.83-1.42-2.76-3.01c0.06-1.41,1.12-2.53,2.46-2.73l-0.26-3.52c0,0-0.01,0-0.01,0c-1.06-0.05-1.87-0.94-1.83-1.99c0.03-0.59,0.32-1.11,0.76-1.45l-1.53-2.6c-0.13,0.04-0.27,0.07-0.41,0.06c-0.61-0.03-1.07-0.54-1.05-1.14c0.03-0.61,0.54-1.07,1.14-1.05c0.61,0.03,1.07,0.54,1.05,1.14c-0.01,0.31-0.15,0.58-0.37,0.77l1.53,2.6c0.26-0.12,0.56-0.18,0.86-0.17c1.06,0.05,1.87,0.94,1.83,1.99c-0.04,0.91-0.7,1.63-1.56,1.8l0.26,3.52C50.47,33.76,50.51,33.76,50.55,33.76z"/>
                        <path fill="#172A88" d="M56.57,33.02c1.56-0.36,3.11,0.62,3.46,2.17c0.36,1.56-0.62,3.11-2.17,3.46c-0.27,0.06-0.54,0.08-0.81,0.07l-0.4,3.04c1.55,0.29,2.85,1.47,3.23,3.1c0.5,2.19-0.87,4.38-3.06,4.88c-2.19,0.5-4.38-0.87-4.88-3.06c-0.5-2.19,0.87-4.38,3.06-4.88c0.41-0.09,0.83-0.12,1.23-0.09l0.4-3.04c-1.07-0.22-1.97-1.05-2.23-2.18c-0.31-1.37,0.41-2.74,1.65-3.29l-1.19-3.32c0,0-0.01,0-0.01,0c-1.03,0.24-2.06-0.41-2.29-1.44c-0.13-0.58,0.01-1.16,0.35-1.6l-2.17-2.1c-0.11,0.08-0.24,0.13-0.38,0.17c-0.59,0.14-1.18-0.23-1.31-0.82c-0.14-0.59,0.23-1.18,0.82-1.31c0.59-0.14,1.18,0.23,1.31,0.82c0.07,0.3,0.01,0.6-0.15,0.84l2.17,2.1c0.22-0.18,0.49-0.32,0.79-0.39c1.03-0.24,2.06,0.41,2.29,1.44c0.2,0.88-0.24,1.76-1.02,2.14l1.19,3.32C56.49,33.04,56.53,33.03,56.57,33.02z"/>
                        <path fill="#2EA7E0" d="M39.75,48.95c0.74,1.42,0.19,3.16-1.23,3.9c-1.42,0.74-3.16,0.19-3.9-1.23c-0.74-1.42-0.19-3.16,1.23-3.9c1.25-0.65,2.75-0.3,3.6,0.76l2.91-1.99c0,0,0-0.01-0.01-0.01c-0.49-0.94-0.12-2.09,0.81-2.58c0.53-0.27,1.13-0.28,1.63-0.06l1.49-2.63c-0.1-0.09-0.19-0.2-0.26-0.32c-0.28-0.54-0.07-1.2,0.47-1.48c0.54-0.28,1.2-0.07,1.48,0.47c0.28,0.54,0.07,1.2-0.47,1.48c-0.27,0.14-0.58,0.16-0.85,0.07l-1.49,2.63c0.23,0.17,0.43,0.39,0.57,0.66c0.49,0.94,0.12,2.09-0.81,2.58c-0.8,0.42-1.77,0.21-2.33-0.45l-2.92,1.99C39.71,48.88,39.73,48.91,39.75,48.95z"/>
                        <path fill="#2EA7E0" d="M43.4,53.79c1.09,1.17,1.02,3-0.15,4.08c-1.17,1.09-3,1.02-4.08-0.15c-0.19-0.2-0.34-0.43-0.46-0.67l-2.84,1.17c0.52,1.48,0.16,3.2-1.07,4.34c-1.65,1.53-4.23,1.44-5.76-0.21c-1.53-1.65-1.44-4.23,0.21-5.76c1.65-1.53,4.23-1.44,5.76,0.21c0.29,0.31,0.52,0.66,0.69,1.02l2.83-1.17c-0.34-1.04-0.08-2.23,0.78-3.02c1.03-0.96,2.57-1.02,3.67-0.22l2.28-2.69c0,0-0.01,0-0.01-0.01c-0.72-0.77-0.67-1.98,0.1-2.7c0.44-0.41,1.01-0.57,1.56-0.49l0.74-2.93c-0.12-0.06-0.24-0.14-0.33-0.24c-0.41-0.44-0.39-1.14,0.06-1.55c0.44-0.41,1.14-0.39,1.55,0.06c0.41,0.44,0.39,1.14-0.06,1.55c-0.23,0.21-0.52,0.31-0.8,0.29l-0.74,2.93c0.27,0.1,0.52,0.26,0.73,0.49c0.72,0.77,0.67,1.98-0.1,2.7c-0.66,0.62-1.65,0.67-2.37,0.18l-2.28,2.69C43.34,53.73,43.37,53.76,43.4,53.79z"/>
                        <path fill="#172A88" d="M21.2,47.19c-0.86,1.35-2.64,1.74-3.99,0.89s-1.74-2.64-0.89-3.99c0.86-1.35,2.64-1.74,3.99-0.89c1.19,0.76,1.63,2.23,1.14,3.5l3.18,1.53c0,0,0-0.01,0.01-0.01c0.57-0.89,1.75-1.15,2.64-0.59c0.5,0.32,0.8,0.83,0.87,1.38l3.02-0.03c0.03-0.13,0.07-0.26,0.15-0.38c0.33-0.51,1-0.66,1.51-0.34c0.51,0.33,0.66,1,0.34,1.51c-0.33,0.51-1,0.66-1.51,0.34c-0.26-0.17-0.43-0.42-0.48-0.7l-3.02,0.03c-0.03,0.29-0.12,0.57-0.29,0.83c-0.57,0.89-1.75,1.15-2.64,0.59c-0.76-0.49-1.06-1.43-0.78-2.25l-3.18-1.53C21.24,47.12,21.22,47.15,21.2,47.19z"/>
                        <path fill="#172A88" d="M18.83,52.77c-0.47,1.53-2.09,2.38-3.61,1.91c-1.53-0.47-2.38-2.09-1.91-3.61c0.08-0.27,0.2-0.51,0.35-0.74l-2.43-1.87c-1.02,1.2-2.7,1.74-4.3,1.25c-2.15-0.66-3.36-2.94-2.7-5.09c0.66-2.15,2.94-3.36,5.09-2.7s3.36,2.94,2.7,5.09c-0.12,0.41-0.31,0.78-0.54,1.11l2.43,1.87c0.73-0.81,1.89-1.18,3-0.84c1.34,0.41,2.17,1.72,2.02,3.07l3.47,0.63c0,0,0-0.01,0-0.01c0.31-1.01,1.38-1.58,2.39-1.27c0.57,0.18,1,0.59,1.21,1.1l2.91-0.83c-0.01-0.13,0-0.27,0.04-0.41c0.18-0.58,0.79-0.9,1.37-0.73c0.58,0.18,0.9,0.79,0.73,1.37c-0.18,0.58-0.79,0.9-1.37,0.73c-0.29-0.09-0.52-0.29-0.65-0.55l-2.91,0.83c0.05,0.28,0.03,0.58-0.06,0.88c-0.31,1.01-1.38,1.58-2.39,1.27c-0.87-0.27-1.4-1.09-1.34-1.96l-3.47-0.63C18.85,52.69,18.84,52.73,18.83,52.77z"/>
                        <path fill="#2EA7E0" d="M13.45,30.24c-1.59-0.07-2.83-1.42-2.76-3.01c0.07-1.59,1.42-2.83,3.01-2.76c1.59,0.07,2.83,1.42,2.76,3.01c-0.06,1.41-1.12,2.53-2.46,2.73l0.26,3.52c0,0,0.01,0,0.01,0c1.06,0.05,1.87,0.94,1.83,1.99c-0.03,0.59-0.32,1.11-0.76,1.45l1.53,2.6c0.13-0.04,0.27-0.07,0.41-0.06c0.61,0.03,1.07,0.54,1.05,1.14c-0.03,0.61-0.54,1.07-1.14,1.05c-0.61-0.03-1.07-0.54-1.05-1.14c0.01-0.31,0.15-0.58,0.37-0.77l-1.53-2.6c-0.26,0.12-0.56,0.18-0.86,0.17c-1.06-0.05-1.87-0.94-1.83-1.99c0.04-0.91,0.7-1.63,1.56-1.8l-0.26-3.52C13.53,30.24,13.49,30.24,13.45,30.24z"/>
                        <path fill="#2EA7E0" d="M7.43,30.98c-1.56,0.36-3.11-0.62-3.46-2.17c-0.36-1.56,0.62-3.11,2.17-3.46c0.27-0.06,0.54-0.08,0.81-0.07l0.4-3.04c-1.55-0.29-2.85-1.47-3.23-3.1c-0.5-2.19,0.87-4.38,3.06-4.88c2.19-0.5,4.38,0.87,4.88,3.06c0.5,2.19-0.87,4.38-3.06,4.88c-0.41,0.09-0.83,0.12-1.23,0.09l-0.4,3.04c1.07,0.22,1.97,1.05,2.23,2.18c0.31,1.37-0.41,2.74-1.65,3.29l1.19,3.32c0,0,0.01,0,0.01,0c1.03-0.24,2.06,0.41,2.29,1.44c0.13,0.58-0.01,1.16-0.35,1.6l2.17,2.1c0.11-0.08,0.24-0.13,0.38-0.17c0.59-0.14,1.18,0.23,1.31,0.82c0.14,0.59-0.23,1.18-0.82,1.31c-0.59,0.14-1.18-0.23-1.31-0.82c-0.07-0.3-0.01-0.6,0.15-0.84l-2.17-2.1c-0.22,0.18-0.49,0.32-0.79,0.39c-1.03,0.24-2.06-0.41-2.29-1.44c-0.2-0.88,0.24-1.76,1.02-2.14l-1.19-3.32C7.51,30.96,7.47,30.97,7.43,30.98z"/>
                        <path fill="#172A88" d="M24.25,15.05c-0.74-1.42-0.19-3.16,1.23-3.9s3.16-0.19,3.9,1.23c0.74,1.42,0.19,3.16-1.23,3.9c-1.25,0.65-2.75,0.3-3.6-0.76l-2.91,1.99c0,0,0,0.01,0.01,0.01c0.49,0.94,0.12,2.09-0.81,2.58c-0.53,0.27-1.13,0.28-1.63,0.06l-1.49,2.63c0.1,0.09,0.19,0.2,0.26,0.32c0.28,0.54,0.07,1.2-0.47,1.48c-0.54,0.28-1.2,0.07-1.48-0.47c-0.28-0.54-0.07-1.2,0.47-1.48c0.27-0.14,0.58-0.16,0.85-0.07l1.49-2.63c-0.23-0.17-0.43-0.39-0.57-0.66c-0.49-0.94-0.12-2.09,0.81-2.58c0.8-0.42,1.77-0.21,2.33,0.45l2.92-1.99C24.29,15.12,24.27,15.09,24.25,15.05z"/>
                        <path fill="#172A88" d="M20.6,10.21c-1.09-1.17-1.02-3,0.15-4.08c1.17-1.09,3-1.02,4.08,0.15c0.19,0.2,0.34,0.43,0.46,0.67l2.84-1.17c-0.52-1.48-0.16-3.2,1.07-4.34c1.65-1.53,4.23-1.44,5.76,0.21c1.53,1.65,1.44,4.23-0.21,5.76c-1.65,1.53-4.23,1.44-5.76-0.21c-0.29-0.31-0.52-0.66-0.69-1.02l-2.83,1.17c0.34,1.04,0.08,2.23-0.78,3.02c-1.03,0.96-2.57,1.02-3.67,0.22l-2.28,2.69c0,0,0.01,0,0.01,0.01c0.72,0.77,0.67,1.98-0.1,2.7c-0.44,0.41-1.01,0.57-1.56,0.49l-0.74,2.93c0.12,0.06,0.24,0.14,0.33,0.24c0.41,0.44,0.39,1.14-0.06,1.55c-0.44,0.41-1.14,0.39-1.55-0.06c-0.41-0.44-0.39-1.14,0.06-1.55c0.23-0.21,0.52-0.31,0.8-0.29l0.74-2.93c-0.27-0.1-0.52-0.26-0.73-0.49c-0.72-0.77-0.67-1.98,0.1-2.7c0.66-0.62,1.65-0.67,2.37-0.18l2.28-2.69C20.66,10.27,20.63,10.24,20.6,10.21z"/>
                    </svg>
                </div>
            </div>
            <div class="tos-xswd-relayer-title">TOS XSWD Relayer</div>
            <canvas></canvas>
        `

        this.element.addEventListener(`click`, (e) => {
            // close the app if clicking outside
            if (this.element.isEqualNode(e.target as Node)) {
                this.relayer.close();
            }
        })

        this.relayer.props.parent.appendChild(this.element)
        this.setLoading()
    }

    clear() {
        this.loadingElement.remove()
        this.errElement.remove()
        this.qrCodeElement.remove()
    }

    setError(msg: string) {
        this.clear()
        this.errElement.innerHTML = `
            <div class="tos-xswd-relayer-error-text">error: ${msg}</div>
        `
        this.contentElement.appendChild(this.errElement)
    }

    setLoading() {
        this.clear()
        this.contentElement.appendChild(this.loadingElement)
    }

    setQRCode(channelId: string) {
        this.clear()

        const canvas = this.qrCodeElement.querySelector(`canvas`)

        const qrCodeData = JSON.stringify({
            inner: {},
            channel_id: channelId,
            relayer: this.relayer.props.url,
            encryption_mode: this.relayer.props.encryption_mode
        } as RelayerAppData)

        QRCode.toCanvas(canvas, qrCodeData, {
            color: {
                dark: `#fff`, // dots
                light: `#000` // background
            }
        })

        this.contentElement.appendChild(this.qrCodeElement)
    }
}
